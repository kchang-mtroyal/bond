<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª½åª½çš„å‚µåˆ¸è¨ˆç®—æ©Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        .input-group label { font-size: 0.9rem; font-weight: 600; color: #374151; }
        .result-card { transition: all 0.3s; }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .schedule-table th { background-color: #f8fafc; color: #475569; font-weight: 600; font-size: 0.85rem; padding: 0.75rem; text-align: right; }
        .schedule-table td { padding: 0.75rem; font-size: 0.9rem; text-align: right; border-bottom: 1px solid #e2e8f0; }
        .schedule-table tr:last-child td { border-bottom: none; }
        .schedule-table td:first-child, .schedule-table th:first-child { text-align: left; }
        
        /* é†’ç›®æç¤ºæ¨£å¼ - åŠ å¼·ç‰ˆ */
        .call-date-row { background-color: #fff9c4 !important; border-left: 5px solid #f59e0b; }
        .call-date-row td { color: #b45309; font-weight: 800; }
        .call-date-tag { display: inline-block; background-color: #f59e0b; color: white; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-800 mb-2">ğŸ’° åª½åª½çš„å‚µåˆ¸å°å¹«æ‰‹</h1>
            <p class="text-gray-600">è¼¸å…¥è³‡æ–™ï¼Œè¼•é¬†å¹«æ‚¨ç®—å‡ºçœŸå¯¦å ±é…¬ç‡èˆ‡ç¾é‡‘æµ</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit">
                <h2 class="text-xl font-bold border-b pb-3 mb-4 text-gray-700 flex items-center">
                    ğŸ“ æ–°å¢å‚µåˆ¸è³‡æ–™
                </h2>
                
                <form id="bondForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å‚µåˆ¸åç¨± (æˆ–æ˜¯ä»£è™Ÿ)</label>
                        <input type="text" id="bondName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" placeholder="ä¾‹å¦‚: èŠ±æ——éŠ€è¡Œ 2035" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">CUSIP (é¸å¡«)</label>
                            <input type="text" id="cusip" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="ä»£ç¢¼">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç¥¨é¢åˆ©ç‡ (%)</label>
                            <input type="number" step="0.001" id="couponRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="5.449" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">è³¼è²·æ—¥æœŸ</label>
                            <input type="date" id="purchaseDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åˆ°æœŸæ—¥</label>
                            <input type="date" id="maturityDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">åˆ¸å•†å¯è´–å›æ—¥ (Call Date)</label>
                        <input type="date" id="callDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" required>
                        <p class="text-xs text-gray-500 mt-1">*ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—ç ´æœˆåˆ©æ¯ä¸¦æ’å…¥åˆ—è¡¨</p>
                    </div>

                    <div class="bg-blue-50 p-3 rounded-lg space-y-3 border border-blue-100">
                        <div>
                            <label class="block text-sm font-medium text-blue-900">ç”³è³¼é¢é¡ (Face Value)</label>
                            <input type="number" id="faceValue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="100000" value="100000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-900">ç”³è³¼æˆäº¤åƒ¹ (Price)</label>
                            <input type="number" step="0.001" id="cleanPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="104.351" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-900">å¯¦éš›ç¹³äº¤ç¸½é‡‘é¡ (å«æ¯è²»)</label>
                            <input type="number" step="0.01" id="totalCost" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="104867.11" required>
                            <p class="text-xs text-blue-600 mt-1">*è«‹çœ‹å°å¸³å–®ä¸Šçš„ Total æ‰£æ¬¾é‡‘é¡</p>
                        </div>
                    </div>

                    <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                        <label class="block text-sm font-medium text-green-900">ç•¶ä¸‹ IBKR å¸‚å ´è³£åƒ¹ (Ask Price)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" step="0.001" id="marketPrice" class="block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="103.50">
                            <button type="button" onclick="searchPrice()" class="bg-green-600 text-white px-3 py-2 rounded shadow hover:bg-green-700 whitespace-nowrap text-sm" title="å» Google æœå°‹åƒ¹æ ¼">
                                ğŸ” æ‰¾åƒ¹æ ¼
                            </button>
                        </div>
                        <p class="text-xs text-green-600 mt-1">*å¦‚æœä¸çŸ¥é“åƒ¹æ ¼ï¼Œè«‹æŒ‰å³é‚ŠæŒ‰éˆ•æœå°‹ CUSIP</p>
                    </div>

                    <button type="button" onclick="addBond()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">
                        â• åŠ å…¥æ¸…å–®ä¸¦è¨ˆç®—
                    </button>
                </form>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š è¨ˆç®—çµæœæ¸…å–®</h2>
                    <div class="space-x-2">
                        <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded shadow flex items-center">
                            ğŸ“¥ åŒ¯å‡º Excel
                        </button>
                        <button onclick="clearAll()" class="text-red-500 hover:text-red-700 text-sm font-semibold underline py-2 px-2">
                            æ¸…ç©ºæ‰€æœ‰
                        </button>
                    </div>
                </div>

                <div id="resultsContainer" class="space-y-4">
                    <div id="emptyState" class="bg-white p-12 rounded-xl shadow border-2 border-dashed border-gray-300 text-center text-gray-400">
                        <p class="text-lg">ğŸ‘ˆ è«‹åœ¨å·¦å´è¼¸å…¥è³‡æ–™ï¼ŒæŒ‰ä¸‹ã€ŒåŠ å…¥ã€æŒ‰éˆ•</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('purchaseDate').value = `${yyyy}-${mm}-${dd}`;

        let bondsDataList = [];

        function searchPrice() {
            const cusip = document.getElementById('cusip').value;
            const name = document.getElementById('bondName').value;
            if (!cusip && !name) {
                alert("è«‹å…ˆè¼¸å…¥ CUSIP ä»£ç¢¼æˆ–å‚µåˆ¸åç¨±ï¼Œæ‰èƒ½æœå°‹ï¼");
                return;
            }
            const query = cusip ? `${cusip} bond price` : `${name} bond price`;
            const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }

        function parseDateInput(id) {
            const val = document.getElementById(id).value;
            if (!val) return null;
            const parts = val.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }

        function addBond() {
            const purchaseDateStr = document.getElementById('purchaseDate').value;
            const maturityDateStr = document.getElementById('maturityDate').value;
            const callDateStr = document.getElementById('callDate').value;

            const data = {
                id: Date.now(),
                name: document.getElementById('bondName').value,
                cusip: document.getElementById('cusip').value || '-',
                couponRate: parseFloat(document.getElementById('couponRate').value),
                purchaseDate: parseDateInput('purchaseDate'),
                maturityDate: parseDateInput('maturityDate'),
                callDate: parseDateInput('callDate'),
                callDateStr: callDateStr, // ä¿å­˜åŸå§‹å­—ä¸²
                faceValue: parseFloat(document.getElementById('faceValue').value),
                cleanPrice: parseFloat(document.getElementById('cleanPrice').value),
                totalCost: parseFloat(document.getElementById('totalCost').value),
                marketPrice: document.getElementById('marketPrice').value ? parseFloat(document.getElementById('marketPrice').value) : null
            };

            if (!data.name || isNaN(data.couponRate) || isNaN(data.totalCost) || !data.purchaseDate || !data.maturityDate) {
                alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼");
                return;
            }

            const result = calculateMetrics(data);
            bondsDataList.push(result);
            renderResult(result);
            
            document.getElementById('bondName').value = '';
            document.getElementById('cusip').value = '';
            document.getElementById('cleanPrice').value = '';
            document.getElementById('totalCost').value = '';
            document.getElementById('emptyState').style.display = 'none';
        }

        function removeBond(id) {
            const card = document.getElementById(`card-${id}`);
            if (card) card.remove();
            bondsDataList = bondsDataList.filter(item => item.input.id !== id);
            if (bondsDataList.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function calculateMetrics(data) {
            const faceVal = data.faceValue;
            const rate = data.couponRate / 100;
            const price = data.cleanPrice / 100;
            
            // è¨ˆç®—å‰æ‰‹æ¯
            let tempDate = new Date(data.maturityDate);
            let couponDates = [];
            while (tempDate > new Date(data.purchaseDate.getFullYear() - 2, 0, 1)) {
                couponDates.push(new Date(tempDate));
                tempDate.setMonth(tempDate.getMonth() - 6);
            }
            couponDates.sort((a, b) => a - b);
            
            let lastCouponDate = couponDates.filter(d => d <= data.purchaseDate).pop();
            let nextCouponDate = couponDates.filter(d => d > data.purchaseDate)[0];
            
            if (!lastCouponDate) lastCouponDate = new Date(nextCouponDate.getTime());
            
            const daysHeld = getDays30360(lastCouponDate, data.purchaseDate);
            const daysInPeriod = 180;
            
            const periodCoupon = faceVal * rate / 2;
            const accruedInterest = periodCoupon * (daysHeld / daysInPeriod);
            const principalCost = faceVal * price;
            const commission = data.totalCost - principalCost - accruedInterest;

            const ytmResult = calculateYield(data.totalCost, data.purchaseDate, data.maturityDate, periodCoupon, nextCouponDate, faceVal);
            const ytcResult = calculateYield(data.totalCost, data.purchaseDate, data.callDate, periodCoupon, nextCouponDate, faceVal);

            // ç”Ÿæˆé…æ¯è©¦ç®—è¡¨ (å‚³å…¥ Call Date å­—ä¸²é€²è¡Œæ¯”å°)
            const schedule = generateSchedule(data.totalCost, data.purchaseDate, data.maturityDate, periodCoupon, nextCouponDate, faceVal, data.callDateStr, data.callDate);

            let marketResult = null;
            if (data.marketPrice) {
                const mPrice = data.marketPrice / 100;
                const estMarketCost = (faceVal * mPrice) + accruedInterest + commission;
                const mYtm = calculateYield(estMarketCost, data.purchaseDate, data.maturityDate, periodCoupon, nextCouponDate, faceVal);
                const mYtc = calculateYield(estMarketCost, data.purchaseDate, data.callDate, periodCoupon, nextCouponDate, faceVal);
                marketResult = { ytm: mYtm, ytc: mYtc, cost: estMarketCost };
            }

            return {
                input: data,
                accruedInterest,
                commission,
                ytm: ytmResult,
                ytc: ytcResult,
                schedule: schedule, 
                market: marketResult
            };
        }

        // æ–°å¢ï¼šæ—¥æœŸæ ¼å¼åŒ– (é¿å…æ™‚å€å•é¡Œ)
        function fmtIsoDate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function generateSchedule(cost, startDate, endDate, periodCoupon, firstCouponDate, faceVal, callDateStr, callDate) {
            let schedule = [];
            
            // 1. ç”¢ç”Ÿæ¨™æº–é…æ¯åˆ—è¡¨
            let standardDates = [];
            let d = new Date(firstCouponDate);
            while (d <= endDate) {
                standardDates.push(new Date(d));
                d.setMonth(d.getMonth() + 6);
            }

            // 2. æº–å‚™è¦éæ­·çš„æ‰€æœ‰æ—¥æœŸ (åŒ…å« Call Date)
            let allDates = standardDates.map(d => ({ date: d, type: 'coupon' }));
            
            // æª¢æŸ¥ Call Date æ˜¯å¦éœ€è¦æ’å…¥
            if (callDate > startDate && callDate <= endDate) {
                const callIso = fmtIsoDate(callDate);
                const exists = standardDates.some(d => fmtIsoDate(d) === callIso);
                if (!exists) {
                    allDates.push({ date: callDate, type: 'call' });
                } else {
                    const match = allDates.find(item => fmtIsoDate(item.date) === callIso);
                    if (match) match.isCallDate = true;
                }
            }
            
            allDates.sort((a, b) => a.date - b.date);

            // 3. éæ­·è¨ˆç®—
            let cumulativeInterest = 0;
            let lastInterestDate = new Date(firstCouponDate); // æ¨ç®—ä¸Šä¸€å€‹é…æ¯æ—¥
            lastInterestDate.setMonth(lastInterestDate.getMonth() - 6);

            allDates.forEach(item => {
                const currentD = item.date;
                let currentAmount = 0;

                if (item.type === 'coupon') {
                    currentAmount = periodCoupon;
                    cumulativeInterest += currentAmount;
                    lastInterestDate = new Date(currentD); 
                } else {
                    // ç ´æœˆåˆ©æ¯è¨ˆç®—
                    const days = getDays30360(lastInterestDate, currentD);
                    const safeDays = Math.max(0, days);
                    currentAmount = periodCoupon * (safeDays / 180);
                }

                // *** ä¿®æ”¹é‡é»ï¼šè¨ˆç®—ç´¯ç©æç›Š ***
                // æƒ…å¢ƒï¼šç•¶æ—¥è´–å› -> æ‹¿å›æœ¬é‡‘ + é€™ä¸€æœŸçš„åˆ©æ¯(æˆ–ç ´æœˆæ¯) + ä¹‹å‰æ‰€æœ‰é ˜åˆ°çš„åˆ©æ¯
                // ç´¯ç©æç›Š = (ç´¯ç©å·²é ˜æ¯ + ç•¶æœŸæ¯ + æœ¬é‡‘) - ç•¶åˆç¸½æˆæœ¬
                // é€™è£¡çš„ cumulativeInterest å·²ç¶“åŒ…å« currentAmount (å¦‚æœæ˜¯ coupon)
                // å¦‚æœæ˜¯ call (type != coupon)ï¼ŒcumulativeInterest é‚„æ²’åŠ ä¸Š currentAmountï¼Œæ‰€ä»¥è¦æ‰‹å‹•åŠ 
                
                let totalReceived = 0;
                if (item.type === 'coupon') {
                    totalReceived = cumulativeInterest + faceVal;
                } else {
                    totalReceived = cumulativeInterest + currentAmount + faceVal;
                }
                
                // æ·¨æç›Šé‡‘é¡
                const netProfit = totalReceived - cost;

                const totalROI = netProfit / cost;
                const daysDiff = (currentD - startDate) / (1000 * 60 * 60 * 24);
                const years = daysDiff / 365;
                const simpleAnnualROI = years > 0 ? (totalROI / years) : 0;

                let tempFlows = [-cost];
                let tempDates = [new Date(startDate)];
                
                allDates.filter(x => x.date < currentD && x.type === 'coupon').forEach(x => {
                    tempFlows.push(periodCoupon);
                    tempDates.push(new Date(x.date));
                });
                
                tempFlows.push(currentAmount + faceVal);
                tempDates.push(new Date(currentD));
                
                const xirrVal = XIRR(tempFlows, tempDates);
                
                const isTargetCall = (item.type === 'call' || item.isCallDate);

                schedule.push({
                    date: currentD,
                    amount: currentAmount,
                    // é€™è£¡ç‚ºäº†è¡¨æ ¼é¡¯ç¤ºï¼Œå¦‚æœæ˜¯ Call Date æ’å…¥è¡Œï¼Œç´¯ç©åˆ©æ¯æˆ‘å€‘é¡¯ç¤ºåˆ°ç•¶ä¸‹æ‹¿åˆ°çš„ç¸½æ¯
                    cumulative: item.type === 'coupon' ? cumulativeInterest : cumulativeInterest + currentAmount,
                    netProfit: netProfit, // æ–°å¢ï¼šç´¯ç©æç›Šé‡‘é¡
                    totalROI: totalROI * 100,
                    simpleAnnualROI: simpleAnnualROI * 100,
                    annualizedROI: xirrVal ? xirrVal * 100 : 0,
                    isCallDate: isTargetCall
                });
            });

            return schedule;
        }

        function calculateYield(cost, startDate, endDate, periodCoupon, firstCouponDate, faceVal) {
            let cashFlows = [-cost];
            let dates = [new Date(startDate)];
            
            let currentD = new Date(firstCouponDate);
            let lastStandardCoupon = new Date(firstCouponDate);
            lastStandardCoupon.setMonth(lastStandardCoupon.getMonth() - 6);

            while (currentD < endDate) {
                cashFlows.push(periodCoupon);
                dates.push(new Date(currentD));
                lastStandardCoupon = new Date(currentD);
                currentD.setMonth(currentD.getMonth() + 6);
            }
            
            let finalPayment = faceVal;
            const isStandardEnd = (fmtIsoDate(currentD) === fmtIsoDate(endDate));
            
            if (isStandardEnd) {
                finalPayment += periodCoupon;
            } else {
                const days = getDays30360(lastStandardCoupon, endDate);
                const safeDays = Math.max(0, days);
                finalPayment += periodCoupon * (safeDays / 180);
            }
            
            cashFlows.push(finalPayment);
            dates.push(new Date(endDate));
            
            const xirrVal = XIRR(cashFlows, dates);
            
            const totalReceived = cashFlows.slice(1).reduce((a, b) => a + b, 0);
            const totalInterest = totalReceived - faceVal;

            return {
                rate: xirrVal * 100,
                totalInterest: totalInterest
            };
        }

        function getDays30360(start, end) {
            let D1 = start.getDate();
            let M1 = start.getMonth();
            let Y1 = start.getFullYear();
            let D2 = end.getDate();
            let M2 = end.getMonth();
            let Y2 = end.getFullYear();
            if (D1 === 31) D1 = 30;
            if (D2 === 31 && D1 === 30) D2 = 30;
            return (Y2 - Y1) * 360 + (M2 - M1) * 30 + (D2 - D1);
        }

        function XIRR(values, dates, guess = 0.05) {
            const tol = 1e-6;
            const maxIter = 100;
            let x0 = guess;
            const t0 = dates[0].getTime();
            const days = dates.map(d => (d.getTime() - t0) / (1000 * 3600 * 24));

            for (let i = 0; i < maxIter; i++) {
                let f = 0;
                let df = 0;
                for (let j = 0; j < values.length; j++) {
                    const factor = Math.pow(1 + x0, days[j] / 365);
                    f += values[j] / factor;
                    df -= (days[j] / 365) * values[j] / (factor * (1 + x0));
                }
                if (Math.abs(f) < tol) return x0;
                const newX = x0 - f / df;
                if (Math.abs(newX - x0) < tol) return newX;
                x0 = newX;
            }
            return null;
        }

        function renderResult(res) {
            const container = document.getElementById('resultsContainer');
            const card = document.createElement('div');
            card.id = `card-${res.input.id}`;
            card.className = "result-card bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 relative";
            
            const fmtMoney = (n) => n.toLocaleString('en-US', {style:'currency', currency:'USD'});
            const fmtPct = (n) => n ? n.toFixed(2) + '%' : 'N/A';
            const fmtDate = (d) => fmtIsoDate(d);

            let compareHtml = '';
            if (res.market) {
                const diff = res.ytm.rate - res.market.ytm.rate;
                const isBetter = diff > 0;
                const colorClass = isBetter ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
                const icon = isBetter ? "âœ…" : "âš ï¸";
                const text = isBetter ? `æ‚¨è²·å¾—çœŸå¥½ï¼æ¯”ç¾åœ¨å¸‚å ´å ±é…¬ç‡é«˜ <b>${diff.toFixed(2)}%</b>` 
                                      : `ç¾åœ¨å¸‚å ´æ¯”è¼ƒä¾¿å®œï¼Œè‹¥ç¾åœ¨è²·å ±é…¬ç‡é«˜ <b>${Math.abs(diff).toFixed(2)}%</b>`;
                compareHtml = `<div class="mt-4 p-3 rounded-lg ${colorClass} text-sm flex items-center"><span class="mr-2 text-xl">${icon}</span><span>å¸‚å ´æ¯”è¼ƒ (Ask: ${res.input.marketPrice}):<br>å¸‚å ´ YTM: <b>${fmtPct(res.market.ytm.rate)}</b> ${text}</span></div>`;
            }

            const profitYtm = (res.ytm.totalInterest + res.input.faceValue) - res.input.totalCost;
            const profitYtc = (res.ytc.totalInterest + res.input.faceValue) - res.input.totalCost;
            
            const fmtProfit = (val) => {
                const color = val >= 0 ? 'text-blue-700' : 'text-red-600';
                return `<span class="${color}">${fmtMoney(val)}</span>`;
            };
            const fmtProfitCall = (val) => {
                const color = val >= 0 ? 'text-orange-700' : 'text-red-600';
                return `<span class="${color}">${fmtMoney(val)}</span>`;
            };

            let scheduleHtml = res.schedule.map((row, idx) => {
                let rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                let dateCellContent = fmtDate(row.date);
                if (row.isCallDate) {
                    rowClass = 'call-date-row'; 
                    dateCellContent += ` <span class="call-date-tag">ğŸ”” æå‰è´–å›</span>`;
                }
                
                // æç›Šé¡è‰²ï¼šè³ºéŒ¢ç¶ è‰²ï¼Œè³ éŒ¢ç´…è‰²
                const profitClass = row.netProfit >= 0 ? 'text-green-700 font-bold' : 'text-red-600 font-bold';

                return `
                    <tr class="${rowClass}">
                        <td>${dateCellContent}</td>
                        <td class="text-blue-600 font-mono">${fmtMoney(row.amount)}</td>
                        <td class="${profitClass} font-mono">${fmtMoney(row.netProfit)}</td>
                        <td class="${row.totalROI >= 0 ? 'text-green-600' : 'text-red-500'} font-bold">${fmtPct(row.totalROI)}</td>
                        <td class="text-gray-600">${fmtPct(row.simpleAnnualROI)}</td>
                        <td class="font-bold text-blue-700">${fmtPct(row.annualizedROI)}</td>
                    </tr>
                `;
            }).join('');

            card.innerHTML = `
                <button onclick="removeBond('${res.input.id}')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500">âœ• åˆªé™¤</button>
                
                <div class="flex flex-wrap items-baseline gap-2 mb-2">
                    <h3 class="text-xl font-bold text-gray-800">${res.input.name}</h3>
                    <span class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">CUSIP: ${res.input.cusip}</span>
                </div>

                <div class="bg-gray-100 rounded-lg p-3 text-xs text-gray-600 grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 border border-gray-200">
                    <div><span class="font-semibold">ç¥¨é¢åˆ©ç‡:</span> ${res.input.couponRate}%</div>
                    <div><span class="font-semibold">æˆäº¤åƒ¹:</span> ${res.input.cleanPrice}</div>
                    <div><span class="font-semibold">è³¼è²·æ—¥:</span> ${fmtDate(res.input.purchaseDate)}</div>
                    <div><span class="font-semibold">åˆ°æœŸæ—¥:</span> ${fmtDate(res.input.maturityDate)}</div>
                    <div><span class="font-semibold">è´–å›æ—¥:</span> ${fmtDate(res.input.callDate)}</div>
                    <div><span class="font-semibold">é¢é¡:</span> ${fmtMoney(res.input.faceValue)}</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div class="space-y-2 text-sm text-gray-600">
                        <p class="font-bold text-gray-700 border-b pb-1 mb-2">ğŸ’° æˆæœ¬çµæ§‹</p>
                        <div class="flex justify-between"><span>ç¹³äº¤ç¸½é‡‘é¡:</span> <span class="font-mono font-bold text-blue-600">${fmtMoney(res.input.totalCost)}</span></div>
                        <div class="flex justify-between"><span>- æ¨ç®—å‰æ‰‹æ¯:</span> <span class="font-mono text-gray-500">${fmtMoney(res.accruedInterest)}</span></div>
                        <div class="flex justify-between"><span>- æ¨ç®—æ‰‹çºŒè²»:</span> <span class="font-mono text-gray-500">${fmtMoney(res.commission)}</span></div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <p class="font-bold text-gray-700 border-b pb-1 mb-2">ğŸ“ˆ å¯¦è³ªå ±é…¬ç‡</p>
                        <div class="bg-blue-50 p-2 rounded">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-900">æŒæœ‰åˆ°æœŸ (YTM)</span>
                                <span class="text-xl font-bold text-blue-700">${fmtPct(res.ytm.rate)}</span>
                            </div>
                            <div class="text-lg font-bold text-right mt-1">é ä¼°ç¸½ç²åˆ©: ${fmtProfit(profitYtm)}</div>
                            <div class="text-xs text-right text-gray-500">(å«æœ¬é‡‘å›æ²– - ç¸½æˆæœ¬)</div>
                        </div>
                        <div class="bg-orange-50 p-2 rounded mt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-orange-900">æå‰è´–å› (YTC)</span>
                                <span class="text-xl font-bold text-orange-700">${fmtPct(res.ytc.rate)}</span>
                            </div>
                            <div class="text-lg font-bold text-right mt-1">é ä¼°ç¸½ç²åˆ©: ${fmtProfitCall(profitYtc)}</div>
                            <div class="text-xs text-right text-gray-500">(å«æœ¬é‡‘å›æ²– - ç¸½æˆæœ¬)</div>
                        </div>
                    </div>
                </div>
                ${compareHtml}

                <div class="mt-6 border-t pt-4">
                    <button onclick="toggleSchedule('${res.input.id}')" class="flex items-center text-blue-600 hover:text-blue-800 font-semibold text-sm">
                        <span class="mr-1">ğŸ“…</span> æŸ¥çœ‹è©³ç´°é…æ¯è©¦ç®—è¡¨ (é»æ“Šå±•é–‹)
                    </button>
                    <div id="schedule-${res.input.id}" class="hidden mt-3 overflow-x-auto">
                        <p class="text-xs text-gray-500 mb-2">* å‡è¨­æƒ…å¢ƒï¼šè‹¥ç™¼è¡Œå…¬å¸é¸æ“‡åœ¨è©²é…æ¯æ—¥ä»¥é¢é¡ ($100) æå‰è´–å›</p>
                        <table class="schedule-table w-full text-left border-collapse bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>é ˜æ¯é‡‘é¡</th>
                                    <th>ç´¯ç©æç›Š</th>
                                    <th>ç¸½å ±é…¬ç‡</th>
                                    <th>ç°¡å–®å¹´åŒ–(ä½ çš„)</th>
                                    <th>å°ˆæ¥­å¹´åŒ–(XIRR)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${scheduleHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.prepend(card);
        }

        function toggleSchedule(id) {
            const el = document.getElementById(`schedule-${id}`);
            el.classList.toggle('hidden');
        }

        function clearAll() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨ˆç®—çµæœå—ï¼Ÿ")) {
                document.getElementById('resultsContainer').innerHTML = '<div id="emptyState" class="bg-white p-12 rounded-xl shadow border-2 border-dashed border-gray-300 text-center text-gray-400"><p class="text-lg">ğŸ‘ˆ è«‹åœ¨å·¦å´è¼¸å…¥è³‡æ–™ï¼ŒæŒ‰ä¸‹ã€ŒåŠ å…¥ã€æŒ‰éˆ•</p></div>';
                bondsDataList = [];
            }
        }

        function exportToExcel() {
            if (bondsDataList.length === 0) {
                alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼");
                return;
            }

            const excelData = bondsDataList.map(item => {
                const fmtDate = (d) => fmtIsoDate(d);
                const profitYtm = (item.ytm.totalInterest + item.input.faceValue) - item.input.totalCost;
                const profitYtc = (item.ytc.totalInterest + item.input.faceValue) - item.input.totalCost;

                return {
                    "å‚µåˆ¸åç¨±": item.input.name,
                    "CUSIP": item.input.cusip,
                    "ç¥¨é¢åˆ©ç‡(%)": item.input.couponRate,
                    "è³¼è²·æ—¥æœŸ": fmtDate(item.input.purchaseDate),
                    "åˆ°æœŸæ—¥": fmtDate(item.input.maturityDate),
                    "è´–å›æ—¥(Call Date)": fmtDate(item.input.callDate),
                    "ç”³è³¼é¢é¡": item.input.faceValue,
                    "å¯¦éš›ç¸½æˆæœ¬": item.input.totalCost,
                    "æˆäº¤åƒ¹(Price)": item.input.cleanPrice,
                    "å‰æ‰‹æ¯(æ¨ç®—)": item.accruedInterest,
                    "æ‰‹çºŒè²»(æ¨ç®—)": item.commission,
                    "æŒæœ‰åˆ°æœŸæ®–åˆ©ç‡(YTM/XIRR)": (item.ytm.rate).toFixed(4) + '%',
                    "åˆ°æœŸç¸½ç²åˆ©": profitYtm.toFixed(2),
                    "æå‰è´–å›æ®–åˆ©ç‡(YTC/XIRR)": (item.ytc.rate).toFixed(4) + '%',
                    "è´–å›ç¸½ç²åˆ©": profitYtc.toFixed(2),
                    "å¸‚å ´æ¯”è¼ƒåƒ¹æ ¼": item.input.marketPrice || '-',
                    "å¸‚å ´YTM": item.market ? (item.market.ytm.rate).toFixed(4) + '%' : '-'
                };
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            const wscols = [
                {wch: 20}, {wch: 12}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15},
                {wch: 12}, {wch: 12}, {wch: 10}, {wch: 12}, {wch: 12},
                {wch: 20}, {wch: 15}, {wch: 20}, {wch: 15}
            ];
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "å‚µåˆ¸è©¦ç®—çµæœ");
            XLSX.writeFile(wb, "My_Bond_Portfolio.xlsx");
        }
    </script>
</body>
</html>
