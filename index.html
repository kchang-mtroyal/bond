<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª½åª½çš„å‚µåˆ¸è¨ˆç®—æ©Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        .input-group label { font-size: 0.9rem; font-weight: 600; color: #374151; }
        .result-card { transition: all 0.3s; }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- æ¨™é¡Œå€ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-800 mb-2">ğŸ’° åª½åª½çš„å‚µåˆ¸å°å¹«æ‰‹</h1>
            <p class="text-gray-600">è¼¸å…¥è³‡æ–™ï¼Œè¼•é¬†å¹«æ‚¨ç®—å‡ºçœŸå¯¦å ±é…¬ç‡ (YTM/YTC)</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šè¼¸å…¥è¡¨å–® -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit">
                <h2 class="text-xl font-bold border-b pb-3 mb-4 text-gray-700 flex items-center">
                    ğŸ“ æ–°å¢å‚µåˆ¸è³‡æ–™
                </h2>
                
                <form id="bondForm" class="space-y-4">
                    <!-- åŸºæœ¬è³‡æ–™ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å‚µåˆ¸åç¨± (æˆ–æ˜¯ä»£è™Ÿ)</label>
                        <input type="text" id="bondName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2" placeholder="ä¾‹å¦‚: èŠ±æ——éŠ€è¡Œ 2035" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">CUSIP (é¸å¡«)</label>
                            <input type="text" id="cusip" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="ä»£ç¢¼">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç¥¨é¢åˆ©ç‡ (%)</label>
                            <input type="number" step="0.001" id="couponRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="5.449" required>
                        </div>
                    </div>

                    <!-- æ—¥æœŸè¨­å®š -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">è³¼è²·æ—¥æœŸ</label>
                            <input type="date" id="purchaseDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åˆ°æœŸæ—¥</label>
                            <input type="date" id="maturityDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">åˆ¸å•†å¯è´–å›æ—¥ (Call Date)</label>
                        <input type="date" id="callDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" required>
                        <p class="text-xs text-gray-500 mt-1">*é€šå¸¸æ˜¯åˆ°æœŸå‰3å€‹æœˆæˆ–1å¹´</p>
                    </div>

                    <!-- é‡‘é¡è¨­å®š -->
                    <div class="bg-blue-50 p-3 rounded-lg space-y-3 border border-blue-100">
                        <div>
                            <label class="block text-sm font-medium text-blue-900">ç”³è³¼é¢é¡ (Face Value)</label>
                            <input type="number" id="faceValue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="100000" value="100000" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-900">ç”³è³¼æˆäº¤åƒ¹ (Price)</label>
                            <input type="number" step="0.001" id="cleanPrice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="104.351" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-900">å¯¦éš›ç¹³äº¤ç¸½é‡‘é¡ (å«æ¯è²»)</label>
                            <input type="number" step="0.01" id="totalCost" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="104867.11" required>
                            <p class="text-xs text-blue-600 mt-1">*è«‹çœ‹å°å¸³å–®ä¸Šçš„ Total æ‰£æ¬¾é‡‘é¡</p>
                        </div>
                    </div>

                    <!-- å¸‚å ´æ¯”è¼ƒ -->
                    <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                        <label class="block text-sm font-medium text-green-900">ç•¶ä¸‹ IBKR å¸‚å ´è³£åƒ¹ (Ask Price)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="number" step="0.001" id="marketPrice" class="block w-full rounded-md border-gray-300 shadow-sm border p-2" placeholder="103.50">
                            <button type="button" onclick="searchPrice()" class="bg-green-600 text-white px-3 py-2 rounded shadow hover:bg-green-700 whitespace-nowrap text-sm" title="å» Google æœå°‹åƒ¹æ ¼">
                                ğŸ” æ‰¾åƒ¹æ ¼
                            </button>
                        </div>
                        <p class="text-xs text-green-600 mt-1">*å¦‚æœä¸çŸ¥é“åƒ¹æ ¼ï¼Œè«‹æŒ‰å³é‚ŠæŒ‰éˆ•æœå°‹ CUSIP</p>
                    </div>

                    <button type="button" onclick="addBond()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">
                        â• åŠ å…¥æ¸…å–®ä¸¦è¨ˆç®—
                    </button>
                </form>
            </div>

            <!-- å³å´ï¼šçµæœæ¸…å–® -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š è¨ˆç®—çµæœæ¸…å–®</h2>
                    <button onclick="clearAll()" class="text-red-500 hover:text-red-700 text-sm font-semibold underline">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                </div>

                <div id="resultsContainer" class="space-y-4">
                    <!-- é€™è£¡æœƒå‹•æ…‹æ’å…¥çµæœå¡ç‰‡ -->
                    <div id="emptyState" class="bg-white p-12 rounded-xl shadow border-2 border-dashed border-gray-300 text-center text-gray-400">
                        <p class="text-lg">ğŸ‘ˆ è«‹åœ¨å·¦å´è¼¸å…¥è³‡æ–™ï¼ŒæŒ‰ä¸‹ã€ŒåŠ å…¥ã€æŒ‰éˆ•</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('purchaseDate').valueAsDate = new Date();

        // å„²å­˜æ‰€æœ‰å‚µåˆ¸è³‡æ–™
        let bondsList = [];

        function searchPrice() {
            const cusip = document.getElementById('cusip').value;
            const name = document.getElementById('bondName').value;
            
            if (!cusip && !name) {
                alert("è«‹å…ˆè¼¸å…¥ CUSIP ä»£ç¢¼æˆ–å‚µåˆ¸åç¨±ï¼Œæ‰èƒ½æœå°‹ï¼");
                return;
            }

            // å„ªå…ˆä½¿ç”¨ CUSIP æœå°‹ï¼Œç²¾æº–åº¦è¼ƒé«˜
            const query = cusip ? `${cusip} bond price` : `${name} bond price`;
            const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }

        function addBond() {
            // 1. ç²å–è¡¨å–®è³‡æ–™
            const data = {
                id: Date.now(),
                name: document.getElementById('bondName').value,
                cusip: document.getElementById('cusip').value || '-',
                couponRate: parseFloat(document.getElementById('couponRate').value),
                purchaseDate: new Date(document.getElementById('purchaseDate').value),
                maturityDate: new Date(document.getElementById('maturityDate').value),
                callDate: new Date(document.getElementById('callDate').value),
                faceValue: parseFloat(document.getElementById('faceValue').value),
                cleanPrice: parseFloat(document.getElementById('cleanPrice').value),
                totalCost: parseFloat(document.getElementById('totalCost').value),
                marketPrice: document.getElementById('marketPrice').value ? parseFloat(document.getElementById('marketPrice').value) : null
            };

            // ç°¡æ˜“é©—è­‰
            if (!data.name || isNaN(data.couponRate) || isNaN(data.totalCost)) {
                alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼");
                return;
            }

            // 2. åŸ·è¡Œè¨ˆç®—
            const result = calculateMetrics(data);
            
            // 3. æ¸²æŸ“çµæœ
            renderResult(result);
            
            // 4. æ¸…é™¤è¡¨å–® (ä¿ç•™æ—¥æœŸæ–¹ä¾¿è¼¸å…¥ä¸‹ä¸€ç­†)
            document.getElementById('bondName').value = '';
            document.getElementById('cusip').value = '';
            document.getElementById('cleanPrice').value = '';
            document.getElementById('totalCost').value = '';
            // document.getElementById('bondForm').reset(); 
            document.getElementById('emptyState').style.display = 'none';
        }

        function calculateMetrics(data) {
            // åŸºç¤åƒæ•¸
            const faceVal = data.faceValue;
            const rate = data.couponRate / 100;
            const price = data.cleanPrice / 100;
            
            // è¨ˆç®—å‰æ‰‹æ¯ (Accrued Interest) - 30/360 è¿‘ä¼¼æ³•
            // å°‹æ‰¾ä¸Šä¸€å€‹é…æ¯æ—¥ (å‡è¨­åŠå¹´é…)
            let tempDate = new Date(data.maturityDate);
            let couponDates = [];
            while (tempDate > new Date(data.purchaseDate.getFullYear() - 1, 0, 1)) {
                couponDates.push(new Date(tempDate));
                tempDate.setMonth(tempDate.getMonth() - 6);
            }
            couponDates.sort((a, b) => a - b);
            
            let lastCouponDate = couponDates.filter(d => d <= data.purchaseDate).pop();
            let nextCouponDate = couponDates.filter(d => d > data.purchaseDate)[0];
            
            // å¦‚æœæ‰¾ä¸åˆ°ä¸Šä¸€å€‹é…æ¯æ—¥(ä¾‹å¦‚æ–°ç™¼è¡Œ)ï¼Œç”¨ç™¼è¡Œæ—¥æˆ–è³¼è²·æ—¥æ¨ç®—
            if (!lastCouponDate) lastCouponDate = new Date(nextCouponDate.getTime()); // ç°¡åŒ–è™•ç†
            
            // è¨ˆç®—å¤©æ•¸ (30/360 logic simplified for JS)
            const daysHeld = getDays30360(lastCouponDate, data.purchaseDate);
            const daysInPeriod = 180; // æ¨™æº–åŠå¹´
            
            const periodCoupon = faceVal * rate / 2;
            const accruedInterest = periodCoupon * (daysHeld / daysInPeriod);
            
            // è¨ˆç®—æ‰‹çºŒè²» (Commission)
            // ç¸½æˆæœ¬ = æœ¬é‡‘(é¢é¡*æ·¨åƒ¹) + å‰æ‰‹æ¯ + æ‰‹çºŒè²»
            const principalCost = faceVal * price;
            const commission = data.totalCost - principalCost - accruedInterest;

            // è¨ˆç®— YTM
            const ytmResult = calculateYield(data.totalCost, data.purchaseDate, data.maturityDate, periodCoupon, nextCouponDate, faceVal);
            
            // è¨ˆç®— YTC
            const ytcResult = calculateYield(data.totalCost, data.purchaseDate, data.callDate, periodCoupon, nextCouponDate, faceVal);

            // è¨ˆç®—å¸‚å ´æ¯”è¼ƒ (å¦‚æœæœ‰å¡«)
            let marketResult = null;
            if (data.marketPrice) {
                const mPrice = data.marketPrice / 100;
                // å‡è¨­ç¾åœ¨è²·ï¼Œæ‰‹çºŒè²»æ¯”ä¾‹è·Ÿç¾åœ¨ä¸€æ¨£ï¼Œå‰æ‰‹æ¯ä¹Ÿä¸€æ¨£(å‡è¨­åŒå¤©äº¤å‰²)
                const estMarketCost = (faceVal * mPrice) + accruedInterest + commission;
                const mYtm = calculateYield(estMarketCost, data.purchaseDate, data.maturityDate, periodCoupon, nextCouponDate, faceVal);
                const mYtc = calculateYield(estMarketCost, data.purchaseDate, data.callDate, periodCoupon, nextCouponDate, faceVal);
                marketResult = { ytm: mYtm, ytc: mYtc, cost: estMarketCost };
            }

            return {
                input: data,
                accruedInterest,
                commission,
                ytm: ytmResult,
                ytc: ytcResult,
                market: marketResult
            };
        }

        function calculateYield(cost, startDate, endDate, periodCoupon, firstCouponDate, faceVal) {
            let cashFlows = [];
            let dates = [];
            
            // T0: ä»˜å‡ºæˆæœ¬ (è² æ•¸)
            cashFlows.push(-cost);
            dates.push(new Date(startDate));
            
            let totalInterest = 0;
            let currentD = new Date(firstCouponDate);
            
            // ç”¢ç”Ÿæœªä¾†ç¾é‡‘æµ
            while (currentD <= endDate) {
                cashFlows.push(periodCoupon);
                dates.push(new Date(currentD));
                totalInterest += periodCoupon;
                currentD.setMonth(currentD.getMonth() + 6);
            }
            
            // æœ€å¾Œä¸€ç­†åŠ ä¸Šæœ¬é‡‘
            // å¦‚æœæœ€å¾Œä¸€ç­†é…æ¯æ—¥ç­‰æ–¼åˆ°æœŸæ—¥ï¼Œç›´æ¥åŠ åœ¨æœ¬é‡‘ä¸Š
            // æ³¨æ„: JS Date æ¯”è¼ƒéœ€è¦è½‰ getTime
            let lastDate = dates[dates.length-1];
            if (lastDate.getTime() === endDate.getTime()) {
                cashFlows[cashFlows.length-1] += faceVal;
            } else {
                cashFlows.push(faceVal);
                dates.push(new Date(endDate));
            }
            
            const xirrVal = XIRR(cashFlows, dates);
            return {
                rate: xirrVal * 100,
                totalInterest: totalInterest
            };
        }

        // 30/360 Day Count Function
        function getDays30360(start, end) {
            let D1 = start.getDate();
            let M1 = start.getMonth();
            let Y1 = start.getFullYear();
            let D2 = end.getDate();
            let M2 = end.getMonth();
            let Y2 = end.getFullYear();

            if (D1 === 31) D1 = 30;
            if (D2 === 31 && D1 === 30) D2 = 30;

            return (Y2 - Y1) * 360 + (M2 - M1) * 30 + (D2 - D1);
        }

        // XIRR æ¼”ç®—æ³• (Newton-Raphson)
        function XIRR(values, dates, guess = 0.05) {
            const tol = 1e-6;
            const maxIter = 100;
            let x0 = guess;
            let f = 0;
            let df = 0;
            
            // å°‡æ—¥æœŸè½‰æ›ç‚ºå¤©æ•¸å·® (ç›¸å°æ–¼ç¬¬ä¸€å¤©)
            const t0 = dates[0].getTime();
            const days = dates.map(d => (d.getTime() - t0) / (1000 * 3600 * 24));

            for (let i = 0; i < maxIter; i++) {
                f = 0;
                df = 0;
                for (let j = 0; j < values.length; j++) {
                    const factor = Math.pow(1 + x0, days[j] / 365);
                    f += values[j] / factor;
                    df -= (days[j] / 365) * values[j] / (factor * (1 + x0));
                }
                
                if (Math.abs(f) < tol) return x0;
                
                const newX = x0 - f / df;
                if (Math.abs(newX - x0) < tol) return newX;
                x0 = newX;
            }
            return null;
        }

        function renderResult(res) {
            const container = document.getElementById('resultsContainer');
            const card = document.createElement('div');
            card.className = "result-card bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 relative";
            
            // æ ¼å¼åŒ–æ•¸å­—
            const fmtMoney = (n) => n.toLocaleString('en-US', {style:'currency', currency:'USD'});
            const fmtPct = (n) => n ? n.toFixed(4) + '%' : 'N/A';
            const fmtDate = (d) => d.toISOString().split('T')[0];

            // åˆ¤æ–·æ¯”è¼ƒçµæœ
            let compareHtml = '';
            if (res.market) {
                const diff = res.ytm.rate - res.market.ytm.rate;
                const isBetter = diff > 0;
                const colorClass = isBetter ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
                const icon = isBetter ? "âœ…" : "âš ï¸";
                const text = isBetter ? `æ‚¨è²·å¾—çœŸå¥½ï¼æ¯”ç¾åœ¨å¸‚å ´å ±é…¬ç‡é«˜ <b>${diff.toFixed(2)}%</b>` 
                                      : `ç¾åœ¨å¸‚å ´æ¯”è¼ƒä¾¿å®œï¼Œè‹¥ç¾åœ¨è²·å ±é…¬ç‡é«˜ <b>${Math.abs(diff).toFixed(2)}%</b>`;
                
                compareHtml = `
                    <div class="mt-4 p-3 rounded-lg ${colorClass} text-sm flex items-center">
                        <span class="mr-2 text-xl">${icon}</span>
                        <span>
                            å¸‚å ´æ¯”è¼ƒ (Ask: ${res.input.marketPrice}):<br>
                            å¸‚å ´ YTM: <b>${fmtPct(res.market.ytm.rate)}</b> | å¸‚å ´ YTC: <b>${fmtPct(res.market.ytc.rate)}</b><br>
                            ${text}
                        </span>
                    </div>
                `;
            }

            card.innerHTML = `
                <button onclick="this.parentElement.remove()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500">âœ• åˆªé™¤</button>
                
                <div class="flex flex-wrap items-baseline gap-2 mb-2">
                    <h3 class="text-xl font-bold text-gray-800">${res.input.name}</h3>
                    <span class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">CUSIP: ${res.input.cusip}</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <!-- å·¦é‚Šï¼šæˆæœ¬åˆ†æ -->
                    <div class="space-y-2 text-sm text-gray-600">
                        <p class="font-bold text-gray-700 border-b pb-1 mb-2">ğŸ’° æˆæœ¬çµæ§‹åˆ†æ</p>
                        <div class="flex justify-between"><span>ç”³è³¼é¢é¡:</span> <span class="font-mono">${fmtMoney(res.input.faceValue)}</span></div>
                        <div class="flex justify-between"><span>ç¹³äº¤ç¸½é‡‘é¡:</span> <span class="font-mono font-bold text-blue-600">${fmtMoney(res.input.totalCost)}</span></div>
                        <div class="flex justify-between"><span>- æ¨ç®—å‰æ‰‹æ¯:</span> <span class="font-mono text-gray-500">${fmtMoney(res.accruedInterest)}</span></div>
                        <div class="flex justify-between"><span>- æ¨ç®—æ‰‹çºŒè²»:</span> <span class="font-mono text-gray-500">${fmtMoney(res.commission)}</span></div>
                    </div>

                    <!-- å³é‚Šï¼šå ±é…¬ç‡ -->
                    <div class="space-y-2 text-sm">
                        <p class="font-bold text-gray-700 border-b pb-1 mb-2">ğŸ“ˆ æ‚¨çš„å¯¦è³ªå ±é…¬ç‡</p>
                        
                        <div class="bg-blue-50 p-2 rounded">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-900">æŒæœ‰åˆ°æœŸ (YTM)</span>
                                <span class="text-xl font-bold text-blue-700">${fmtPct(res.ytm.rate)}</span>
                            </div>
                            <div class="text-xs text-blue-400 text-right">é ä¼°æ·¨åˆ©æ¯æ”¶å…¥: ${fmtMoney(res.ytm.totalInterest - res.accruedInterest)}</div>
                        </div>

                        <div class="bg-orange-50 p-2 rounded mt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-orange-900">æå‰è´–å› (YTC)</span>
                                <span class="text-xl font-bold text-orange-700">${fmtPct(res.ytc.rate)}</span>
                            </div>
                            <div class="text-xs text-orange-400 text-right">è´–å›æ—¥: ${fmtDate(new Date(res.input.callDate))}</div>
                        </div>
                    </div>
                </div>
                ${compareHtml}
            `;

            container.prepend(card);
        }

        function clearAll() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨ˆç®—çµæœå—ï¼Ÿ")) {
                document.getElementById('resultsContainer').innerHTML = '<div id="emptyState" class="bg-white p-12 rounded-xl shadow border-2 border-dashed border-gray-300 text-center text-gray-400"><p class="text-lg">ğŸ‘ˆ è«‹åœ¨å·¦å´è¼¸å…¥è³‡æ–™ï¼ŒæŒ‰ä¸‹ã€ŒåŠ å…¥ã€æŒ‰éˆ•</p></div>';
            }
        }
    </script>
</body>
</html>
